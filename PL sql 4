-- Clean-up if exists
BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE Borrower';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE Fine';
EXCEPTION WHEN OTHERS THEN NULL;
END;
/

-- Create tables
CREATE TABLE Borrower(
  Roll_no NUMBER,
  Name VARCHAR2(30),
  Date_of_Issue DATE,
  Name_of_Book VARCHAR2(50),
  Status CHAR(1)
);

CREATE TABLE Fine(
  Roll_no NUMBER,
  Date_ DATE,
  Amt NUMBER
);

-- Insert sample data
INSERT INTO Borrower VALUES (1, 'Harshad', SYSDATE - 20, 'DBMS', 'I');
INSERT INTO Borrower VALUES (2, 'Sneha', SYSDATE - 35, 'CN', 'I');
COMMIT;

-- Unnamed PL/SQL Block
SET SERVEROUTPUT ON;
DECLARE
  v_roll Borrower.Roll_no%TYPE := &Roll_no;
  v_book Borrower.Name_of_Book%TYPE := '&Book_Name';
  v_date Borrower.Date_of_Issue%TYPE;
  v_days NUMBER;
  v_fine NUMBER := 0;
  e_not_found EXCEPTION;
BEGIN
  -- Get issue date
  SELECT Date_of_Issue INTO v_date
  FROM Borrower
  WHERE Roll_no = v_roll AND Name_of_Book = v_book;

  -- Calculate number of days
  v_days := TRUNC(SYSDATE - v_date);

  -- Decide fine
  IF v_days BETWEEN 15 AND 30 THEN
      v_fine := v_days * 5;
  ELSIF v_days > 30 THEN
      v_fine := v_days * 50;
  ELSE
      v_fine := 0;
  END IF;

  -- Update status to 'R'
  UPDATE Borrower SET Status = 'R'
  WHERE Roll_no = v_roll AND Name_of_Book = v_book;

  -- Insert into Fine table if applicable
  IF v_fine > 0 THEN
      INSERT INTO Fine VALUES (v_roll, SYSDATE, v_fine);
  END IF;

  DBMS_OUTPUT.PUT_LINE('Book Returned Successfully!');
  DBMS_OUTPUT.PUT_LINE('Days: ' || v_days || '  Fine: ' || v_fine);

EXCEPTION
  WHEN NO_DATA_FOUND THEN
     DBMS_OUTPUT.PUT_LINE('No record found for entered Roll number or Book!');
  WHEN OTHERS THEN
     DBMS_OUTPUT.PUT_LINE('Error occurred while processing!');
END;
/
